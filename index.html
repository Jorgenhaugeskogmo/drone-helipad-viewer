<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drone vs Helipad ‚Äî Interaktiv oversikt</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root { --bg:#0b0f14; --card:#131a22; --muted:#9fb0c3; --accent:#5ec3ff; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0b0f14;color:#eaf2fb}
    header{position:sticky;top:0;z-index:1000;background:linear-gradient(180deg,#0b0f14 0%, rgba(11,15,20,.6) 100%);backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid #1e2936}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 18px}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:14px;max-width:1400px;margin:12px auto;padding:0 18px}
    .grid.collapsed{grid-template-columns:48px 1fr}
    .card{background:var(--card);border:1px solid #1e2936;border-radius:14px}
    .card h2{margin:0;padding:14px 14px 8px;font-size:16px;border-bottom:1px solid #1e2936}
    .card .body{padding:12px 14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input[type=file], select, button, input[type=number], input[type=date]{background:#0f1620;color:#eaf2fb;border:1px solid #273547;border-radius:10px;padding:8px 10px;font-size:13px}
    input[type=range]{accent-color:#5ec3ff;background:#0f1620;border:1px solid #273547;border-radius:999px;height:6px;-webkit-appearance:none;width:180px}
    input[type=range]::-webkit-slider-runnable-track{height:6px;background:#172232;border-radius:999px}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;margin-top:-5px;width:16px;height:16px;border-radius:50%;background:#5ec3ff;border:1px solid #167ae6}
    input[type=range]::-moz-range-track{height:6px;background:#172232;border-radius:999px}
    input[type=range]::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:#5ec3ff;border:1px solid #167ae6}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#1a90ff,#167ae6);border-color:#167ae6}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#0f1620;border:1px solid #273547;border-radius:999px;padding:6px 10px;font-size:12px;color:#cfe6ff}
    #map{height:760px;width:100%;border-radius:14px}
    .legend{font-size:12px;color:#cfe6ff;display:flex;gap:12px;flex-wrap:wrap}
    .legend .dot{width:10px;height:10px;border-radius:50%}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #213042}
    th{color:#cfe6ff;text-align:left;cursor:pointer}
    tr:hover{background:#0f1620}
    .muted{color:var(--muted)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{background:#0f1620;border:1px solid #273547;border-radius:999px;padding:6px 10px;font-size:12px}
    .footer{max-width:1200px;margin:24px auto;color:var(--muted);font-size:12px;padding:0 18px}
    .warn{color:#ffd27b}
    /* Fullscreen adjustments for map */
    #map:fullscreen, #map:-webkit-full-screen { height:100vh; width:100vw; border-radius:0 }
    /* Ops list as separate box beside map */
    .map-row{display:flex;gap:12px;align-items:stretch}
    .map-row #map{flex:1 1 0%; width:auto; min-width:0}
    .ops-box{width:320px;max-height:760px;overflow:auto;background:#0f1620;border:1px solid #273547;border-radius:14px}
    .ops-box .ops-head{position:sticky;top:0;background:#0f1620;border-bottom:1px solid #273547;border-top-left-radius:14px;border-top-right-radius:14px;padding:10px 12px;font-size:12px;color:#cfe6ff;display:flex;justify-content:space-between;align-items:center}
    .ops-box .ops-list{padding:10px 10px}
    .ops-item{padding:8px;border:1px solid #1e2936;border-radius:10px;margin-bottom:8px;background:#0b1420}
    .ops-item small{color:#9fb0c3}
    #controls.collapsed .body{display:none}
    #controls.collapsed h2{writing-mode:vertical-rl;text-orientation:mixed;padding:14px 8px;border:none;cursor:pointer;user-select:none}
    #collapseBtn{position:absolute;top:8px;right:8px;background:transparent;border:1px solid #273547;color:#9fb0c3;padding:4px 8px;font-size:11px;border-radius:6px;cursor:pointer}
    #collapseBtn:hover{background:#0f1620;color:#cfe6ff}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .grid.collapsed{grid-template-columns:1fr}
      #map{height:520px}
    }
    /* Login overlay */
    #loginOverlay{position:fixed;top:0;left:0;right:0;bottom:0;background:#0b0f14;z-index:9999;display:flex;align-items:center;justify-content:center}
    #loginBox{background:var(--card);border:1px solid #1e2936;border-radius:14px;padding:32px;max-width:400px;width:90%}
    #loginBox h2{margin:0 0 8px;font-size:24px}
    #loginBox p{color:var(--muted);margin:0 0 24px}
    #loginBox input[type=password]{width:100%;margin-bottom:16px}
    #loginError{color:#ff5a5a;font-size:13px;margin-top:8px;display:none}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <div id="loginOverlay">
    <div id="loginBox">
      <h2>üîê Innlogging kreves</h2>
      <p>Skriv inn passord for √• f√• tilgang til Drone Helipad Viewer</p>
      <input type="password" id="passwordInput" placeholder="Passord" autocomplete="off" />
      <button class="primary" id="loginBtn" style="width:100%">Logg inn</button>
      <div id="loginError">‚ùå Feil passord. Pr√∏v igjen.</div>
    </div>
  </div>
  <header>
    <div class="wrap">
      <h1>Drone vs Helipad ‚Äì Interaktiv oversikt</h1>
      <div class="sub">Ferdig byggefri app. Statiske data i <code>/data</code>. Last opp egne CSV-er om √∏nskelig.</div>
    </div>
  </header>

  <main class="grid" id="mainGrid">
    <section class="card" id="controls" style="position:relative">
      <button id="collapseBtn" title="Skjul/vis panel">‚óÄ</button>
      <h2>1) Data</h2>
      <div class="body">
        <div class="row">
          <label class="pill"><input type="checkbox" id="useBuiltIn" checked style="margin-right:8px"> Bruk innebygde datafiler</label>
        </div>
        <div class="row" id="fileRow">
          <div>
            <label>POI CSV (kolonner: name,lat,lon)</label><br>
            <input type="file" id="poiFile" accept=".csv" />
          </div>
          <div>
            <label>Drone CSV (kolonner: lat,lon[,start])</label><br>
            <input type="file" id="droneFile" accept=".csv" />
          </div>
        </div>
        <div class="chips">
          <span class="chip">N√•r ¬´innebygd¬ª er p√•, hentes <code>./data/poi.csv</code> og <code>./data/drone_ops.csv</code>.</span>
        </div>
      </div>

      <h2>2) Parametre</h2>
      <div class="body">
        <div class="row">
          <div>
            <label>Buffer (km)</label><br>
            <input type="number" id="r1" value="1" step="0.5" style="width:80px">
            <input type="number" id="r2" value="3" step="0.5" style="width:80px">
            <input type="number" id="r3" value="5" step="0.5" style="width:80px">
          </div>
          <div>
            <label>Dato fra</label><br>
            <input type="date" id="dateFrom">
          </div>
          <div>
            <label>Dato til</label><br>
            <input type="date" id="dateTo">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="primary" id="runBtn">Kj√∏r analyse</button>
          <button id="exportCsvBtn">Eksporter tabell (CSV)</button>
          <button id="exportPngBtn">Eksporter kart (PNG)</button>
          <button id="fullscreenBtn">Fullskjerm kart</button>
          <button id="openNewTabBtn">√Öpne kart i ny fane</button>
        </div>
        <div class="row" style="margin-top:8px">
          <label>Heatmap opasitet</label>
          <input type="range" id="heatOpacity" min="0" max="1" step="0.05" value="0.35" style="width:180px">
          <span class="pill" id="heatOpacityVal">0.35</span>
        </div>
      <div class="row" style="margin-top:8px">
        <label>Kartlag</label>
        <select id="basemapSelect">
          <option value="osm">Kart (OSM)</option>
          <option value="esri">Satellitt (Esri)</option>
          <option value="eox">Satellitt (EOX)</option>
        </select>
      </div>
        <div class="legend" style="margin-top:10px">
          <div><span class="dot" style="background:#ff5a5a"></span> Buffer 1</div>
          <div><span class="dot" style="background:#ffb554"></span> Buffer 2</div>
          <div><span class="dot" style="background:#ffe36e"></span> Buffer 3</div>
          <div class="muted">‚Ä¢ Gr√• punkter = droneflygninger ‚Ä¢ Marker = helipad/base ‚Ä¢ Heatmap viser tetthet</div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Kart & N√∏kkeltall</h2>
      <div class="body">
        <div class="map-row">
          <div id="map" style="order:1"></div>
          <section class="ops-box" id="opsPanel" style="display:none; order:2">
            <div class="ops-head"><span>Droneoperasjoner i utsnitt</span><span class="muted" id="opsCount">0</span></div>
            <div class="ops-list" id="opsList"></div>
          </section>
        </div>
        <div class="row" style="margin-top:10px">
          <span class="pill" id="poiCount">POI: ‚Äì</span>
          <span class="pill" id="droneCount">Dronepunkter: ‚Äì</span>
          <span class="pill" id="within5">‚â§5 km (alle POI): ‚Äì</span>
        </div>
      </div>
      <div class="body" style="padding-top:0">
        <h3 style="margin:0 0 8px;font-size:15px">Oppsummering per POI</h3>
        <div class="muted" style="margin-bottom:6px">Sorter ved √• klikke p√• kolonneoverskrifter</div>
        <div style="overflow:auto;max-height:320px;border:1px solid #213042;border-radius:10px">
          <table id="summaryTable">
            <thead>
              <tr>
                <th data-k="POI">POI</th>
                <th data-k="z01">0‚Äì1 km</th>
                <th data-k="z13">1‚Äì3 km</th>
                <th data-k="z35">3‚Äì5 km</th>
                <th data-k="sum">Sum ‚â§5 km</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <div class="footer">
    ‚öôÔ∏è 100% statisk. Legg mappen p√• Vercel som ¬´Other/Static¬ª. <span class="warn">NB:</span> Store datasett kan trenge et datofilter for ytelse.
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>
  <script>
    // Password protection - using SHA-256 hash for security
    // To generate a new hash, open browser console and run: 
    // crypto.subtle.digest('SHA-256', new TextEncoder().encode('YourPassword')).then(h => console.log(Array.from(new Uint8Array(h)).map(b => b.toString(16).padStart(2, '0')).join('')))
    const PASSWORD_HASH = 'a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3'; // Hash of: 123
    
    async function hashPassword(password) {
      const msgBuffer = new TextEncoder().encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
    
    function checkAuth() {
      const isAuthenticated = sessionStorage.getItem('droneAuthToken');
      if (isAuthenticated === PASSWORD_HASH) {
        document.getElementById('loginOverlay').classList.add('hidden');
        // Auto-load data for already authenticated users
        window.addEventListener('load', () => {
          setTimeout(() => {
            runAnalysis();
            setTimeout(updateUrl, 500);
          }, 500);
        });
        return true;
      }
      return false;
    }

    async function handleLogin() {
      const password = document.getElementById('passwordInput').value;
      const errorDiv = document.getElementById('loginError');
      
      const hash = await hashPassword(password);
      
      if (hash === PASSWORD_HASH) {
        sessionStorage.setItem('droneAuthToken', PASSWORD_HASH);
        document.getElementById('loginOverlay').classList.add('hidden');
        errorDiv.style.display = 'none';
        // Auto-load data after successful login
        setTimeout(() => {
          runAnalysis();
          setTimeout(updateUrl, 500);
        }, 500);
      } else {
        errorDiv.style.display = 'block';
        document.getElementById('passwordInput').value = '';
        document.getElementById('passwordInput').focus();
      }
    }

    document.getElementById('loginBtn').addEventListener('click', handleLogin);
    document.getElementById('passwordInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleLogin();
    });

    // Check auth on page load
    checkAuth();
    
    const map = L.map('map', { zoomControl: true, preferCanvas: true }).setView([61.836, 8.568], 8);
    const baseOsm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18, attribution: '&copy; OpenStreetMap' });
    const baseEsri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: '&copy; Esri ‚Äî World Imagery', crossOrigin: true });
    const baseEOX = L.tileLayer('https://tiles.maps.eox.at/wmts/1.0.0/s2cloudless-2020_3857/default/g/{z}/{y}/{x}.jpg', { maxZoom: 18, attribution: 'EOX ‚Äî Sentinel-2 cloudless 2020', crossOrigin: true });
    let currentBase = 'osm';
    baseOsm.addTo(map);
    L.control.layers({ 'Kart (OSM)': baseOsm, 'Satellitt (Esri)': baseEsri, 'Satellitt (EOX)': baseEOX }, {}, { position: 'topleft' }).addTo(map);
    
    // Initialize map screenshoter for high-quality PNG export
    const screenshoter = new SimpleMapScreenshoter({
      hideElementsWithSelectors: ['.leaflet-control-container', '.leaflet-top', '.leaflet-bottom']
    }).addTo(map);

    let poi = [];
    let drones = [];
    let heatMinOpacity = 0.35;

    // Viewport summary control (top-right)
    const viewportSummaryControl = L.control({ position: 'topright' });
    viewportSummaryControl.onAdd = function(){
      const div = L.DomUtil.create('div', 'pill');
      div.id = 'viewportSummary';
      div.style.pointerEvents = 'none';
      div.textContent = 'Utsnitt: ‚Äì';
      return div;
    };
    viewportSummaryControl.addTo(map);

    const poiLayer = L.layerGroup().addTo(map);
    const bufferLayer = L.layerGroup().addTo(map);
    const droneLayer = L.layerGroup().addTo(map);
    const heatLayerGroup = L.layerGroup().addTo(map);

    const poiCountEl = document.getElementById('poiCount');
    const droneCountEl = document.getElementById('droneCount');
    const within5El = document.getElementById('within5');

    function parseDateSafe(s){
      if(!s) return null;
      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }

    function haversineKm(lat1, lon1, lat2, lon2){
      const R = 6371.0;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function drawMap(r1, r2, r3, dateFrom, dateTo){
      poiLayer.clearLayers();
      bufferLayer.clearLayers();
      droneLayer.clearLayers();
      heatLayerGroup.clearLayers();

      poi.forEach(p => {
        L.marker([p.lat, p.lon], {title:p.name}).bindTooltip(p.name).addTo(poiLayer);
        const colors = ['#ff5a5a','#ffb554','#ffe36e'];
        [r1,r2,r3].forEach((r, idx) => {
          if(!r) return;
          L.circle([p.lat,p.lon], {radius:r*1000, color:colors[idx], fill:false, weight:1, opacity:.7}).addTo(bufferLayer);
        });
      });

      let dFiltered = drones;
      if(dateFrom || dateTo){
        dFiltered = drones.filter(d => {
          if(!d.start) return false;
          if(dateFrom && d.start < dateFrom) return false;
          if(dateTo && d.start > dateTo) return false;
          return true;
        });
      }

      const maxPts = 40000;
      const step = Math.ceil(dFiltered.length / maxPts);
      const sample = step > 1 ? dFiltered.filter((_,i)=> i%step===0) : dFiltered;

      sample.forEach(d => {
        L.circleMarker([d.lat, d.lon], {radius:2, color:'#a8b6c9', opacity:.6, fillOpacity:.6}).addTo(droneLayer);
      });

      const heatData = sample.map(d => [d.lat, d.lon, 0.9]);
      if(heatData.length){
        const heat = L.heatLayer(heatData, {radius:22, blur:12, minOpacity:heatMinOpacity});
        heat.addTo(heatLayerGroup);
      }

      const lim = r3 || 5;
      let within = 0;
      for(const d of dFiltered){
        let minD = Infinity;
        for(const p of poi){
          const dist = haversineKm(d.lat, d.lon, p.lat, p.lon);
          if(dist < minD) minD = dist;
          if(minD <= lim) break;
        }
        if(minD <= lim) within++;
      }
      poiCountEl.textContent = `POI: ${poi.length}`;
      droneCountEl.textContent = `Dronepunkter: ${dFiltered.length.toLocaleString('no-NO')}`;
      within5El.textContent = `‚â§${lim} km (alle POI): ${within.toLocaleString('no-NO')}`;

      const allLatLngs = [];
      poi.forEach(p=> allLatLngs.push([p.lat,p.lon]));
      sample.forEach(d=> allLatLngs.push([d.lat,d.lon]));
      if(allLatLngs.length){
        try{ map.fitBounds(allLatLngs, {padding:[30,30]}); }catch(e){}
      }

      // Update viewport summary after drawing
      updateViewportSummary(dateFrom, dateTo);
    }

    function buildSummary(r1, r2, r3, dateFrom, dateTo){
      let dFiltered = drones;
      if(dateFrom || dateTo){
        dFiltered = drones.filter(d => {
          if(!d.start) return false;
          if(dateFrom && d.start < dateFrom) return false;
          if(dateTo && d.start > dateTo) return false;
          return true;
        });
      }
      const rows = poi.map(p => ({ POI:p.name, z01:0, z13:0, z35:0, sum:0 }));
      for(const d of dFiltered){
        for(let i=0;i<poi.length;i++){
          const p = poi[i];
          const dist = haversineKm(d.lat,d.lon,p.lat,p.lon);
          if(dist <= r1){ rows[i].z01++; rows[i].sum++; }
          else if(dist <= r2){ rows[i].z13++; rows[i].sum++; }
          else if(dist <= r3){ rows[i].z35++; rows[i].sum++; }
        }
      }
      rows.sort((a,b)=> b.sum - a.sum);
      return rows;
    }

    function renderSummaryTable(rows){
      const tbody = document.querySelector('#summaryTable tbody');
      tbody.innerHTML = '';
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.POI}</td><td>${r.z01}</td><td>${r.z13}</td><td>${r.z35}</td><td><b>${r.sum}</b></td>`;
        tbody.appendChild(tr);
      }
    }

    function updateViewportSummary(dateFrom, dateTo){
      const el = document.getElementById('viewportSummary');
      if(!el) return;
      // Determine viewport bounds
      const b = map.getBounds();
      const inView = drones.filter(d => b.contains([d.lat, d.lon]));

      // Date filter context
      let df = dateFrom, dt = dateTo;
      // If not provided (e.g., initial draw), try read from inputs
      if(!df && !dt){
        df = document.getElementById('dateFrom').value ? new Date(document.getElementById('dateFrom').value) : null;
        dt = document.getElementById('dateTo').value ? new Date(document.getElementById('dateTo').value) : null;
      }
      const inViewDate = (df || dt) ? inView.filter(d => {
        if(!d.start) return false;
        if(df && d.start < df) return false;
        if(dt && d.start > dt) return false;
        return true;
      }) : inView;

      // Zoom-based granularity label
      const z = map.getZoom();
      const gran = z >= 12 ? 'kvartal' : z >= 9 ? 'bydel' : z >= 7 ? 'region' : 'nasjonalt';

      // Date reference label
      let dateLbl = '';
      if(df && dt) dateLbl = `${df.toISOString().slice(0,10)} ‚Üí ${dt.toISOString().slice(0,10)}`;
      else if(df) dateLbl = `fra ${df.toISOString().slice(0,10)}`;
      else if(dt) dateLbl = `til ${dt.toISOString().slice(0,10)}`;
      else dateLbl = 'alle datoer';

      el.textContent = `Utsnitt (${gran}): ${inViewDate.length.toLocaleString('no-NO')} punkter ‚Ä¢ ${dateLbl}`;

      // Render ops list (right panel)
      const opsPanel = document.getElementById('opsPanel');
      const opsList = document.getElementById('opsList');
      const opsCount = document.getElementById('opsCount');
      if(!opsPanel || !opsList || !opsCount) return;

      opsList.innerHTML = '';
      if(inViewDate.length === 0){
        opsPanel.style.display = 'none';
        opsCount.textContent = '0';
        return;
      }
      // sort by date desc if available, fallback to lat/lon
      const sorted = [...inViewDate].sort((a,b)=>{
        const at = a.start ? a.start.getTime() : -Infinity;
        const bt = b.start ? b.start.getTime() : -Infinity;
        return bt - at;
      }).slice(0, 500); // cap list for performance

      for(const d of sorted){
        const dateStr = d.start ? d.start.toISOString().slice(0,10) : 'ukjent dato';
        const item = document.createElement('div');
        item.className = 'ops-item';
        item.innerHTML = `<div><b>${d.lat.toFixed(5)}, ${d.lon.toFixed(5)}</b></div><small>${dateStr}</small>`;
        opsList.appendChild(item);
      }
      opsCount.textContent = String(inViewDate.length);
      opsPanel.style.display = '';
    }

    function loadCsv(file){
      return new Promise((resolve, reject)=>{
        Papa.parse(file, { header:true, skipEmptyLines:true, dynamicTyping:true, complete: res => resolve(res.data), error: reject });
      });
    }

    async function loadCsvFromUrl(url){
      try {
        console.log('Laster CSV fra:', url);
        const res = await fetch(url);
        if(!res.ok) {
          console.error('Feil ved lasting av CSV:', res.status, res.statusText);
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const txt = await res.text();
        console.log('CSV lastet, st√∏rrelse:', txt.length, 'bytes');
        return new Promise((resolve)=>{
          Papa.parse(txt, { header:true, skipEmptyLines:true, dynamicTyping:true, complete: r => {
            console.log('CSV parsed, rader:', r.data.length);
            resolve(r.data);
          }});
        });
      } catch(err) {
        console.error('Kritisk feil ved lasting av CSV:', err);
        alert('Kunne ikke laste datafiler. Sjekk console for detaljer.');
        throw err;
      }
    }

    document.getElementById('exportCsvBtn').addEventListener('click', ()=>{
      const rows = [['POI','0-1 km','1-3 km','3-5 km','Sum ‚â§5 km']];
      document.querySelectorAll('#summaryTable tbody tr').forEach(tr=>{
        const tds = Array.from(tr.children).map(td=>td.innerText);
        rows.push([tds[0], tds[1], tds[2], tds[3], tds[4]]);
      });
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'poi_summary.csv';
      a.click();
    });

    document.getElementById('exportPngBtn').addEventListener('click', async ()=>{
      try {
        const format = 'png';
        const overridedPluginOptions = {
          mimeType: 'image/png',
          caption: null,
          hideElementsWithSelectors: ['.leaflet-control-container']
        };
        const image = await screenshoter.takeScreen(format, overridedPluginOptions);
        
        // Download the image
        const link = document.createElement('a');
        link.download = `kart-${new Date().toISOString().slice(0,10)}.png`;
        link.href = image.blob ? URL.createObjectURL(image.blob) : image.image;
        link.click();
      } catch(err) {
        console.error('Feil ved eksport:', err);
        alert('Kunne ikke eksportere kart. Pr√∏v igjen.');
      }
    });

    // Opacity slider
    const heatOpacityInput = document.getElementById('heatOpacity');
    const heatOpacityVal = document.getElementById('heatOpacityVal');
    function refreshMapOnly(){
      const r1 = parseFloat((document.getElementById('r1')).value) || 1;
      const r2 = parseFloat((document.getElementById('r2')).value) || 3;
      const r3 = parseFloat((document.getElementById('r3')).value) || 5;
      const df = document.getElementById('dateFrom').value ? new Date(document.getElementById('dateFrom').value) : null;
      const dt = document.getElementById('dateTo').value ? new Date(document.getElementById('dateTo').value) : null;
      drawMap(r1, r2, r3, df, dt);
    }
    if(heatOpacityInput){
      heatOpacityVal.textContent = Number(heatOpacityInput.value).toFixed(2);
      heatOpacityInput.addEventListener('input', (e)=>{
        heatMinOpacity = Number(e.target.value);
        heatOpacityVal.textContent = heatMinOpacity.toFixed(2);
        refreshMapOnly();
      });
    }

    // Basemap select
    const basemapSelect = document.getElementById('basemapSelect');
    if(basemapSelect){
      basemapSelect.addEventListener('change', (e)=>{
        const v = e.target.value;
        // remove others
        [baseOsm, baseEsri, baseEOX].forEach(l=>{ if(map.hasLayer(l)) map.removeLayer(l); });
        if(v === 'osm'){
          baseOsm.addTo(map); currentBase = 'osm';
        } else if(v === 'esri'){
          // try esri, fallback to eox on error
          baseEsri.addTo(map); currentBase = 'esri';
          baseEsri.once('tileerror', ()=>{ [baseEsri].forEach(l=> map.removeLayer(l)); baseEOX.addTo(map); currentBase = 'eox'; basemapSelect.value = 'eox'; });
        } else if(v === 'eox'){
          baseEOX.addTo(map); currentBase = 'eox';
        }
      });
    }

    // Fullscreen toggle for map
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    function updateFsButton(){
      fullscreenBtn.textContent = document.fullscreenElement ? 'Avslutt fullskjerm' : 'Fullskjerm kart';
    }
    document.addEventListener('fullscreenchange', updateFsButton);
    fullscreenBtn.addEventListener('click', ()=>{
      const el = document.getElementById('map');
      if(!document.fullscreenElement){
        (el.requestFullscreen && el.requestFullscreen()) || (el.webkitRequestFullscreen && el.webkitRequestFullscreen());
      } else {
        (document.exitFullscreen && document.exitFullscreen()) || (document.webkitExitFullscreen && document.webkitExitFullscreen());
      }
    });
    updateFsButton();

    // Open map in new tab (standalone full-view)
    const openNewTabBtn = document.getElementById('openNewTabBtn');
    openNewTabBtn.addEventListener('click', ()=>{
      window.open('/map.html', '_blank');
    });

    async function runAnalysis(){
      console.log('Kj√∏r analyse-knapp klikket');
      const r1 = parseFloat((document.getElementById('r1')).value) || 1;
      const r2 = parseFloat((document.getElementById('r2')).value) || 3;
      const r3 = parseFloat((document.getElementById('r3')).value) || 5;
      const df = document.getElementById('dateFrom').value ? new Date(document.getElementById('dateFrom').value) : null;
      const dt = document.getElementById('dateTo').value ? new Date(document.getElementById('dateTo').value) : null;

      const useBuiltIn = (document.getElementById('useBuiltIn')).checked;
      console.log('Bruk innebygde filer:', useBuiltIn);
      let poiData, drData;

      if(useBuiltIn){
        console.log('Laster innebygde datafiler...');
        [poiData, drData] = await Promise.all([
          loadCsvFromUrl('/data/poi.csv'),
          loadCsvFromUrl('/data/drone_ops.csv')
        ]);
        console.log('Datafiler lastet. POI:', poiData.length, 'Drone:', drData.length);
      } else {
        const poiFile = (document.getElementById('poiFile')).files[0];
        const droneFile = (document.getElementById('droneFile')).files[0];
        if(!poiFile || !droneFile){ alert('Last opp b√•de POI- og drone-CSV, eller skru p√• ¬´innebygde datafiler¬ª.'); return; }
        [poiData, drData] = await Promise.all([loadCsv(poiFile), loadCsv(droneFile)]);
      }

      poi = poiData.map(r=>({ name: r.name || r.POI || r.Navn || r.navn || r.site || r.base || 'POI', lat: Number(r.lat ?? r.latitude ?? r.Lat ?? r.Latitude), lon: Number(r.lon ?? r.long ?? r.lng ?? r.Long ?? r.Lng) })).filter(p=> Number.isFinite(p.lat) && Number.isFinite(p.lon) && p.lat >= 55 && p.lat <= 72 && p.lon >= -5 && p.lon <= 35);

      drones = drData.map(r=>({ lat: Number(r.lat ?? r.latitude ?? r.Lat ?? r.Latitude), lon: Number(r.lon ?? r.long ?? r.lng ?? r.Long ?? r.Lng), start: parseDateSafe(r.start ?? r.Fra ?? r.from ?? r.Start ?? r['start_time'] ?? r.timestamp) })).filter(d=> Number.isFinite(d.lat) && Number.isFinite(d.lon) && d.lat >= 55 && d.lat <= 72 && d.lon >= -5 && d.lon <= 35);

      drawMap(r1,r2,r3, df, dt);
      const rows = buildSummary(r1,r2,r3, df, dt);
      renderSummaryTable(rows);
    }
    
    document.getElementById('runBtn').addEventListener('click', runAnalysis);

    // Collapse toggle
    const collapseBtn = document.getElementById('collapseBtn');
    const controlsPanel = document.getElementById('controls');
    const mainGrid = document.getElementById('mainGrid');
    let isCollapsed = false;
    collapseBtn.addEventListener('click', ()=>{
      isCollapsed = !isCollapsed;
      if(isCollapsed){
        controlsPanel.classList.add('collapsed');
        mainGrid.classList.add('collapsed');
        collapseBtn.textContent = '‚ñ∂';
        collapseBtn.style.right = '50%';
        collapseBtn.style.transform = 'translateX(50%)';
      } else {
        controlsPanel.classList.remove('collapsed');
        mainGrid.classList.remove('collapsed');
        collapseBtn.textContent = '‚óÄ';
        collapseBtn.style.right = '8px';
        collapseBtn.style.transform = 'none';
      }
      setTimeout(()=> map.invalidateSize(), 300);
    });

    // URL state management
    function getUrlParams(){
      const params = new URLSearchParams(window.location.search);
      return {
        r1: params.get('r1') ? parseFloat(params.get('r1')) : 1,
        r2: params.get('r2') ? parseFloat(params.get('r2')) : 3,
        r3: params.get('r3') ? parseFloat(params.get('r3')) : 5,
        dateFrom: params.get('dateFrom') || '',
        dateTo: params.get('dateTo') || '',
        heatOpacity: params.get('heatOpacity') ? parseFloat(params.get('heatOpacity')) : 0.35,
        basemap: params.get('basemap') || 'osm',
        lat: params.get('lat') ? parseFloat(params.get('lat')) : null,
        lon: params.get('lon') ? parseFloat(params.get('lon')) : null,
        zoom: params.get('zoom') ? parseInt(params.get('zoom')) : null
      };
    }

    function updateUrl(){
      const params = new URLSearchParams();
      const r1 = document.getElementById('r1').value;
      const r2 = document.getElementById('r2').value;
      const r3 = document.getElementById('r3').value;
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      const heatOp = document.getElementById('heatOpacity').value;
      const basemap = document.getElementById('basemapSelect').value;
      const center = map.getCenter();
      const zoom = map.getZoom();

      if(r1 != '1') params.set('r1', r1);
      if(r2 != '3') params.set('r2', r2);
      if(r3 != '5') params.set('r3', r3);
      if(dateFrom) params.set('dateFrom', dateFrom);
      if(dateTo) params.set('dateTo', dateTo);
      if(heatOp != '0.35') params.set('heatOpacity', heatOp);
      if(basemap != 'osm') params.set('basemap', basemap);
      params.set('lat', center.lat.toFixed(4));
      params.set('lon', center.lng.toFixed(4));
      params.set('zoom', zoom);

      const newUrl = window.location.pathname + '?' + params.toString();
      window.history.replaceState({}, '', newUrl);
    }

    // Load from URL on init
    const urlParams = getUrlParams();
    document.getElementById('r1').value = urlParams.r1;
    document.getElementById('r2').value = urlParams.r2;
    document.getElementById('r3').value = urlParams.r3;
    document.getElementById('dateFrom').value = urlParams.dateFrom;
    document.getElementById('dateTo').value = urlParams.dateTo;
    document.getElementById('heatOpacity').value = urlParams.heatOpacity;
    document.getElementById('heatOpacityVal').textContent = urlParams.heatOpacity.toFixed(2);
    heatMinOpacity = urlParams.heatOpacity;
    document.getElementById('basemapSelect').value = urlParams.basemap;
    
    // Apply basemap from URL
    if(urlParams.basemap !== 'osm'){
      [baseOsm, baseEsri, baseEOX].forEach(l=>{ if(map.hasLayer(l)) map.removeLayer(l); });
      if(urlParams.basemap === 'esri'){ baseEsri.addTo(map); currentBase = 'esri'; }
      else if(urlParams.basemap === 'eox'){ baseEOX.addTo(map); currentBase = 'eox'; }
    }
    
    // Apply map position from URL (only if valid Norway-ish coordinates)
    if(urlParams.lat && urlParams.lon && urlParams.zoom){
      // Only apply if coordinates seem reasonable for Norway/Scandinavia
      if(urlParams.lat >= 55 && urlParams.lat <= 72 && urlParams.lon >= -5 && urlParams.lon <= 35){
        map.setView([urlParams.lat, urlParams.lon], urlParams.zoom);
      }
    }

    // Update viewport summary on pan/zoom
    map.on('moveend zoomend', ()=> {
      updateViewportSummary();
      updateUrl();
    });

    // Update URL when params change
    ['r1','r2','r3','dateFrom','dateTo'].forEach(id => {
      document.getElementById(id).addEventListener('change', updateUrl);
    });
    document.getElementById('heatOpacity').addEventListener('change', updateUrl);
    document.getElementById('basemapSelect').addEventListener('change', updateUrl);
  </script>
</body>
</html>
